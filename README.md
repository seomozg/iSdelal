# iSdelal โ Qdrant + FastAPI (OpenAI) + Nginx RAG Kit

ะะพัะพะฒัะน ะบะพะผะฟะปะตะบั ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ ะธ ะฟัะพะดะฐะบัะตะฝะฐ: Qdrant (ะฒะตะบัะพั ะะ) + FastAPI backend (OpenAI embeddings + GPT-4.1) + Nginx (ะพะฑัะฐัะฝัะน ะฟัะพะบัะธ) + JS-ะฒะธะดะถะตั ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฝะฐ ัะฐะนัั.

---

## ๐ ะะฐัะฝะธัะต ะพัััะดะฐ!

### ๐ **[GET_STARTED.md](./GET_STARTED.md)** โ ะงะะขะะะขะ ะกะะะงะะะ

ะะพะปะฝะฐั ะฟะพัะฐะณะพะฒะฐั ะธะฝััััะบัะธั:
1. ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ
2. GitHub setup
3. ะะตะฟะปะพะน ะฝะฐ test-domain.ru

**ะะปะธ ะฟัะพะฒะตัััะต** [`STATUS.md`](./STATUS.md) ะดะปั ะฟะพะปะฝะพะณะพ ัะฟะธัะบะฐ ััะพ ะฑัะปะพ ะฟะพะดะณะพัะพะฒะปะตะฝะพ.

---

## ๐ ะัััััะน ััะฐัั

### ะะพะบะฐะปัะฝะพ (ะดะปั ัะฐะทัะฐะฑะพัะบะธ)
See [`LOCAL_SETUP.md`](./LOCAL_SETUP.md) ะดะปั ะฟะพัะฐะณะพะฒะพะน ะธะฝััััะบัะธะธ.

**ะะพัะพัะบะฐั ะฒะตััะธั:**
```powershell
docker compose up --build
# ะ ะดััะณะพะผ ัะตัะผะธะฝะฐะปะต:
docker compose logs -f backend
```

### ะะฐ ัะตัะฒะตั test-domain.ru (ะดะตะฟะปะพะน)
See [`DEPLOY.md`](./DEPLOY.md) ะดะปั ะฟะพะปะฝะพะน ะธะฝััััะบัะธะธ ะฟะพ ัะฐะทะฒะตัััะฒะฐะฝะธั.

**ะะพัะพัะบะฐั ะฒะตััะธั:**
```bash
cd /opt/iSdelal
git pull origin main
docker compose up --build -d
```

---

## ๐ ะะพะบัะผะตะฝัะฐัะธั

| ะะพะบัะผะตะฝั | ะะฐะทะฝะฐัะตะฝะธะต |
|----------|-----------|
| [`LOCAL_SETUP.md`](./LOCAL_SETUP.md) | ๐ฅ๏ธ ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ ะฝะฐ Windows/Mac/Linux |
| [`DEPLOY.md`](./DEPLOY.md) | ๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะฝะฐ test-domain.ru ั HTTPS |
| [`GITHUB_SETUP.md`](./GITHUB_SETUP.md) | ๐ ะะฐัััะพะนะบะฐ GitHub ัะตะฟะพะทะธัะพัะธั ะธ Actions |
| [`QUICK_COMMANDS.md`](./QUICK_COMMANDS.md) | โก ะจะฟะฐัะณะฐะปะบะฐ ั ัะฐัััะผะธ ะบะพะผะฐะฝะดะฐะผะธ |
| [`backend/.env.example`](./backend/.env.example) | โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั |
| [`backend/tests/test_api.py`](./backend/tests/test_api.py) | ๐งช Unit-ัะตััั (11 ัะตััะพะฒ) |

---

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะปะธะตะฝั (ะฑัะฐัะทะตั)                                           โ
โ ะัััะพะตะฝะฝัะน ะฒะธะดะถะตั: widget.js                               โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ HTTP/HTTPS (POST /api/chat)
                     โ
โโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Nginx (Reverse Proxy) - Port 8081 (ะปะพะบะฐะปัะฝะพ)              โ
โ - ะัะพะบัะธััะตั /api/* โ backend:8000                         โ
โ - ะะฐะทะดะฐะตั ััะฐัะธะบั /widget/*                                โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
        โโโโโโโโโโโโโโดโโโโโโโโโโโโโ
        โ                         โ
โโโโโโโโโผโโโโโโโ        โโโโโโโโโโผโโโโโโโ
โ Backend      โ        โ Qdrant        โ
โ FastAPI      โโโโโโโโโถโ Vector DB     โ
โ Port 8000    โ        โ Port 6333     โ
โ              โ        โ               โ
โ /api/ingest  โ        โ Collections   โ
โ /api/chat    โ        โ & vectors     โ
โ /api/health  โ        โ               โ
โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโ
```

---

## ๐ฆ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
iSdelal/
โโโ LOCAL_SETUP.md           โ ๐ ะะฐัะฝะธัะต ะพัััะดะฐ ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ
โโโ DEPLOY.md                โ ๐ ะะฝััััะบัะธั ะดะตะฟะปะพั ะฝะฐ test-domain.ru
โโโ .gitignore               โ ะะณะฝะพัะธััะตะผ .env, __pycache__, ะธ ั.ะด.
โโโ docker-compose.yml       โ Production ะบะพะฝัะธะณ
โโโ docker-compose.override.yml โ Development (ะณะพัััะฐั ะฟะตัะตะทะฐะณััะทะบะฐ)
โ
โโโ backend/
โ   โโโ .env                 โ ๐ ะะพะบะฐะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต (ะฒ .gitignore)
โ   โโโ .env.example         โ ๐ ะจะฐะฑะปะพะฝ ะดะปั .env
โ   โโโ requirements.txt      โ Python ะทะฐะฒะธัะธะผะพััะธ
โ   โโโ Dockerfile           โ Docker ะพะฑัะฐะท ะดะปั backend
โ   โโโ app/
โ   โ   โโโ main.py          โ ๐ FastAPI ัะพัะบะฐ ะฒัะพะดะฐ
โ   โ   โโโ ingest.py        โ ๐ท๏ธ ะัะฐัะปะตั (Playwright + BeautifulSoup)
โ   โ   โโโ rag.py           โ ๐ ะะพะธัะบ + ะฟัะพะผะฟั ะดะปั LLM
โ   โ   โโโ qdrant_client.py โ ๐๏ธ ะะพะผะพัะฝะธะบ ะดะปั Qdrant
โ   โ   โโโ utils.py         โ ๐๏ธ ะฃัะธะปะธัั (chunking ะธ ั.ะด.)
โ   โโโ tests/
โ       โโโ test_api.py      โ ๐งช 11 pytest ัะตััะพะฒ
โ
โโโ widget/
โ   โโโ widget.js            โ ๐ฌ JS ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ัะฐัะฐ ะฝะฐ ัะฐะนัั
โ   โโโ widget.css           โ ๐จ ะกัะธะปะธ ะฒะธะดะถะตัะฐ
โ
โโโ nginx/
โ   โโโ default.conf         โ โ๏ธ Nginx ะบะพะฝัะธะณััะฐัะธั
โ   โโโ Dockerfile           โ Docker ะพะฑัะฐะท ะดะปั nginx
โ
โโโ .github/
    โโโ copilot-instructions.md โ ๐ ะะฝััััะบัะธะธ ะดะปั AI ะฟะพะผะพัะฝะธะบะพะฒ
    โโโ workflows/
        โโโ tests.yml        โ โ GitHub Actions: ะทะฐะฟััะบ ัะตััะพะฒ
        โโโ deploy.yml       โ ๐ (ะพะฟัะธะพะฝะฐะปัะฝะพ) ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะดะตะฟะปะพะน
```

---

## ๐ API Endpoints

ะัะต endpoints ััะตะฑััั ะทะฐะณะพะปะพะฒะพะบ `X-API-Key: <api_key>` (ัััะฐะฝะพะฒะธัะต ะฒ `.env`).

### Health Check
```bash
GET /api/health
# โ ะัะฒะตั: {"status": "ok"}
```

### ะะฝะถะตะบั ะบะพะฝัะตะฝัะฐ (ะธะฝะดะตะบัะธัะพะฒะฐะฝะธะต)

**ะะตะถะธะผ 1: ะะฒัะพ-ะบัะฐัะป ัะฐะนัะฐ**
```bash
curl -X POST "http://localhost:8081/api/ingest" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "url": "https://example.com",
    "collection": "example_site"
  }'
```

**ะะตะถะธะผ 2: ะะพะฝะบัะตัะฝัะต URL**
```bash
curl -X POST "http://localhost:8081/api/ingest" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "urls": [
      "https://example.com/page1",
      "https://example.com/page2"
    ],
    "collection": "example_site"
  }'
```

### ะงะฐั ั RAG
```bash
curl -X POST "http://localhost:8081/api/chat" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "question": "What is this website about?",
    "collection": "example_site"
  }'

# โ ะัะฒะตั:
# {
#   "answer": "Based on the website...",
#   "sources": ["https://example.com/page1", ...]
# }
```

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

```powershell
# ะะพะบะฐะปัะฝะพ (ั Python)
cd backend
pip install -r requirements.txt
pytest tests/test_api.py -v

# ะะปะธ ะฒ ะบะพะฝัะตะนะฝะตัะต
docker compose exec backend pytest tests/test_api.py -v
```

**ะงัะพ ัะตััะธััะตััั:**
- โ API ะฐััะตะฝัะธัะธะบะฐัะธั (X-API-Key)
- โ Health check
- โ ะะฝะถะตะบั ะธ ะฟะพะธัะบ ะฒ Qdrant
- โ Chat ั LLM
- โ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

---

## โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะกะบะพะฟะธััะนัะต `backend/.env.example` ะฒ `backend/.env` ะธ ะพััะตะดะฐะบัะธััะนัะต:

```bash
# backend/.env
OPENAI_API_KEY=sk-...              # ะะปัั OpenAI API
API_KEY=your-strong-secret-key     # ะกะตะบัะตั ะดะปั X-API-Key header
QDRANT_HOST=qdrant                 # ะฅะพัั Qdrant (ะฒ Docker: "qdrant")
QDRANT_PORT=6333                   # ะะพัั Qdrant
EMBED_MODEL=text-embedding-3-large # OpenAI embedding ะผะพะดะตะปั
RAG_TOP_K=5                         # ะะฐะบั ะบะพะฝัะตะบััะฝัะต ััะฐะณะผะตะฝัั ะดะปั LLM
CRAWL_MAX_PAGES=50                 # ะะฐะบั ัััะฐะฝะธั ะฟัะธ ะฐะฒัะพ-ะบัะฐัะปะต
CRAWL_TIMEOUT=30                   # ะขะฐะนะผะฐัั ะฝะฐ ัััะฐะฝะธัะต (ัะตะบ)
USE_PLAYWRIGHT=true                # ะะตะฝะดะตัะธะฝะณ JS ัะตัะตะท Playwright
```

---

## ๐๏ธ ะะฐะทัะฐะฑะพัะบะฐ

### ะะพัััะฐั ะฟะตัะตะทะฐะณััะทะบะฐ backend

Backend ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะทะฐะณััะถะฐะตััั ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ `backend/app/*.py` ะฑะปะฐะณะพะดะฐัั `docker-compose.override.yml`:

```powershell
# ะะทะผะตะฝัะตัะต ัะฐะนะป โ uvicorn ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะทะฐะณััะถะฐะตั
# ะกะผะพััะธัะต ะปะพะณะธ:
docker compose logs -f backend

# ะะตั ะฝะตะพะฑัะพะดะธะผะพััะธ ะฟะตัะตะทะฐะฟััะบะฐัั ะบะพะฝัะตะนะฝะตั!
```

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ ัะฝะดะฟะพะธะฝัะฐ

1. ะะพะฑะฐะฒััะต ะผะฐััััั ะฒ `backend/app/main.py`:
```python
@app.post("/api/my-endpoint")
async def my_endpoint(req: MyRequest):
    # ะะฐั ะบะพะด
    return {"result": "..."}
```

2. ะัะพัะตััะธััะนัะต ะปะพะบะฐะปัะฝะพ
3. ะะพะฑะฐะฒััะต ัะตัั ะฒ `backend/tests/test_api.py`
4. ะะพะผะผะธัััะต ะธ ะฟััััะต ะฒ Git
5. ะกะพะทะดะฐะนัะต PR ะฝะฐ GitHub
6. ะะพัะปะต merge โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะดะตะฟะปะพะน ะฝะฐ test-domain.ru

---

## ๐ ะะฝัะตะณัะฐัะธั ะฒะธะดะถะตัะฐ ะฝะฐ ัะฐะนั

**ะะฐ ะฒะฐัะตะผ ัะฐะนัะต:**
```html
<script>
  // ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟะตัะตะด ะทะฐะณััะทะบะพะน ัะบัะธะฟัะฐ
  window.AIWidgetConfig = {
    apiBase: 'https://test-domain.ru',      // ะะปะธ http://localhost:8081 ะปะพะบะฐะปัะฝะพ
    collection: 'my_site_collection',       // ะะผั ะบะพะปะปะตะบัะธะธ ะฒ Qdrant
    apiKey: 'your-api-key'                  // ะกะตะบัะตั ะธะท X-API-Key
  };
</script>

<!-- ะะฐะณััะทะธัะต ะฒะธะดะถะตั -->
<script src="https://test-domain.ru/widget/widget.js"></script>

<!-- ะะฝะพะฟะบะฐ ะดะปั ะพัะบัััะธั ัะฐัะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ) -->
<button onclick="window.AIWidget.toggle()">๐ฌ Ask AI</button>
```

**ะะปะธ ะฟัะพะณัะฐะผะผะฝะพ:**
```javascript
AIWidget.init({
  apiBase: 'https://test-domain.ru',
  collection: 'my_site_collection',
  apiKey: 'your-api-key'
});
```

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- โ ะัะต endpoints ััะตะฑััั `X-API-Key` header
- โ `.env` ัะฐะนะป ะฒ `.gitignore` (ะฝะธะบะพะณะดะฐ ะฝะต ะบะพะผะผะธัััะต ัะตะบัะตัั!)
- โ HTTPS ะฝะฐ production (Let's Encrypt ัะตััะธัะธะบะฐัั)
- โ Rate limiting (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะฝะฐัััะฐะธะฒะฐะตััั ะฒ Nginx)
- โ CORS ะฟะพะปะธัะธะบะฐ (ะฝะฐัััะฐะธะฒะฐะตััั ะฒ `nginx/default.conf`)

---

## ๐จ Troubleshooting

| ะัะพะฑะปะตะผะฐ | ะะตัะตะฝะธะต |
|----------|---------|
| `docker compose up` ะฝะต ัะฐะฑะพัะฐะตั | ะฃะฑะตะดะธัะตัั, ััะพ Docker Desktop ะทะฐะฟััะตะฝ |
| API ะฝะต ะพัะฒะตัะฐะตั | `docker compose logs backend` |
| ะะพัััะฐั ะฟะตัะตะทะฐะณััะทะบะฐ ะฝะต ัะฐะฑะพัะฐะตั | `docker compose restart backend` |
| Qdrant ะฟะพัะตััะป ะดะฐะฝะฝัะต | `docker compose down -v` ัะดะฐะปะธั ะฒัั! ะัะฟะพะปัะทัะนัะต `docker compose down` ะดะปั ัะพััะฐะฝะตะฝะธั |
| OPENAI_API_KEY ะพัะธะฑะบะฐ | ะัะพะฒะตัััะต `backend/.env`, ะฟะตัะตะทะฐะณััะทะธัะต: `docker compose restart backend` |
| ะกะตััะธัะธะบะฐั Let's Encrypt ะธัััะบ | ะะฐะฟัััะธัะต `sudo certbot renew` ะฝะฐ ัะตัะฒะตัะต |

**ะะพะปะฝะฐั ะดะธะฐะณะฝะพััะธะบะฐ:**
```bash
docker compose ps              # ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
docker compose logs backend    # ะะพะณะธ backend
docker compose logs qdrant     # ะะพะณะธ Qdrant
curl http://localhost:8081/api/health  # ะัะพะฒะตัะบะฐ API
```

---

## ๐ ะะธัะตะฝะทะธั

MIT

---

## ๐ฏ ะกะปะตะดัััะธะต ัะฐะณะธ

1. **ะะพะบะฐะปัะฝะพ**: 
   - See [`LOCAL_SETUP.md`](./LOCAL_SETUP.md)
   - ะะฐะฟัััะธัะต: `docker compose up --build`
   - ะขะตััะธััะนัะต API

2. **ะะฐ GitHub**:
   - ะะฝะธัะธะฐะปะธะทะธััะนัะต ัะตะฟะพะทะธัะพัะธะน: `git init`
   - ะะพะฑะฐะฒััะต secrets ะฒ GitHub Settings:
     - `OPENAI_API_KEY` (ะดะปั GitHub Actions ัะตััะพะฒ)
     - `DEPLOY_KEY` (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะดะตะฟะปะพั)

3. **ะะฐ ัะตัะฒะตั test-domain.ru**:
   - See [`DEPLOY.md`](./DEPLOY.md)
   - ะกะปะตะดัะนัะต ะธะฝััััะบัะธัะผ ะฝะฐัััะพะนะบะธ HTTPS
   - ะะตัะฒัะน ะดะตะฟะปะพะน: `git clone + docker compose up`
   - ะะฑะฝะพะฒะปะตะฝะธั: `git pull + docker compose up --build -d`

---

**ะะพะฟัะพัั?** ะกะผะพััะธัะต ะดะพะบัะผะตะฝัะฐัะธั ะธะปะธ ะพัะบัะพะนัะต Issue ะฝะฐ GitHub.


